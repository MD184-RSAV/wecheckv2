<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeCheck - SAV National</title>
    <style>
        :root { --primary: #0056b3; --accent: #ffd700; --bg: #f4f6f9; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background-color: var(--bg); margin: 0; padding: 15px; color: #333; }
        .container { max-width: 500px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        h1 { text-align: center; color: var(--primary); font-size: 1.8rem; margin-bottom: 5px; }
        input { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; box-sizing: border-box; margin-bottom: 10px; outline: none; }
        input:focus { border-color: var(--primary); }
        button { width: 100%; background-color: var(--primary); color: white; padding: 14px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; }
        .store-header { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .store-name { font-weight: bold; font-size: 1rem; color: #2c3e50; }
        .change-store { font-size: 0.8rem; text-decoration: underline; color: #666; cursor: pointer; }
        #resultat { display: none; border-top: 5px solid #28a745; animation: slideIn 0.3s ease-out; }
        .action-box { font-size: 1.2rem; font-weight: 800; color: #2c3e50; margin: 15px 0; background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center; }
        .info-row { display: flex; align-items: center; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; }
        .icon { font-size: 1.5rem; margin-right: 15px; }
        .weight-options { display: flex; gap: 10px; margin-top: 10px; }
        .weight-btn { flex: 1; padding: 15px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; font-weight: bold; }
        
        /* Liste de suggestions */
        .suggestions { border: 1px solid #ddd; border-radius: 8px; background: white; position: absolute; width: 100%; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: none; margin-top: -10px; }
        .suggestion-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #eee; }
        .suggestion-item:hover { background-color: #f0f7ff; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <h1>WeCheck <span style="font-size:0.5em; background:var(--accent); padding:2px 6px; border-radius:4px;">V2</span></h1>
    <div id="loader" style="text-align:center; padding:20px;">‚è≥ Connexion aux bases de donn√©es...</div>

    <div id="setupScreen" class="card" style="display:none;">
        <h2>üìç Mon Magasin</h2>
        <p>Tapez votre num√©ro de magasin :</p>
        <input type="number" id="inputMagNum" placeholder="Ex: 2, 140, 76..." oninput="rechercherMagasin()">
        <div id="magFound" style="margin-top:10px; font-weight:bold; color: var(--primary);"></div>
        <button id="btnSaveMag" onclick="saveMagasin()" style="display:none; margin-top:10px;">Confirmer ce magasin</button>
    </div>

    <div id="appScreen" style="display:none;">
        <div class="store-header">
            <div><div style="font-size:0.7rem; color:#888;">MAGASIN</div><div class="store-name" id="displayStoreName"></div></div>
            <div class="change-store" onclick="resetMagasin()">Changer</div>
        </div>

        <div class="card" style="position:relative;">
            <label>üîé <b>Marque du produit :</b></label>
            <input type="text" id="marqueInput" placeholder="Tapez les premi√®res lettres..." oninput="filtrerMarques()" autocomplete="off">
            <div id="marqueSuggestions" class="suggestions"></div>
            <button onclick="validerSaisieMarque()" id="btnCheck" style="display:none;">V√©rifier le process</button>
        </div>

        <div id="choixPoids" class="card" style="display:none; text-align:center;">
            <h2>‚öñÔ∏è Poids du colis</h2>
            <div class="weight-options">
                <button class="weight-btn" onclick="afficherResultatFinal('PETIT')">üì¶ -30 KG</button>
                <button class="weight-btn" onclick="afficherResultatFinal('LOURD')">üöõ +30 KG</button>
            </div>
        </div>

        <div id="resultat" class="card">
            <h2 id="resMarqueTitle" style="color:var(--primary); font-size:1.1rem; border-bottom:1px solid #eee; padding-bottom:5px;"></h2>
            <div class="action-box" id="resAction"></div>
            <div class="info-row"><div class="icon">üöö</div><div><b>Transporteur :</b><br><span id="resTransport"></span></div></div>
            <div class="info-row" id="rowHotline"><div class="icon">üìû</div><div><b>Hotline :</b><br><span id="resHotline"></span></div></div>
            <button onclick="nouvelleRecherche()" style="background:#666; margin-top:10px;">Nouvelle recherche</button>
        </div>
    </div>
</div>

<script>
    const URL_MAGASINS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjNaEwFSpDYb5LQIzqhIYuUTjxzyyU-86073JIHI-o4ksrfbb0t7SLV__YiaJZQ4tFk955Hfko9epH/pub?gid=1552475916&single=true&output=csv";
    const URL_REGLES = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjNaEwFSpDYb5LQIzqhIYuUTjxzyyU-86073JIHI-o4ksrfbb0t7SLV__YiaJZQ4tFk955Hfko9epH/pub?gid=1894491300&single=true&output=csv";

    let DB_MAGASINS = [];
    let DB_REGLES = {};
    let MAG_INDEX = null;
    let MARQUE_SEL = null;

    async function init() {
        try {
            const [resM, resR] = await Promise.all([fetch(URL_MAGASINS), fetch(URL_REGLES)]);
            parseMagasins(await resM.text());
            parseRegles(await resR.text());
            document.getElementById("loader").style.display = "none";
            checkMemoire();
        } catch (e) { document.getElementById("loader").innerText = "‚ùå Erreur de connexion au Sheet"; }
    }

    function parseMagasins(csv) {
        const lines = csv.split('\n');
        for (let i = 1; i < lines.length; i++) {
            const c = lines[i].split(',');
            if (c.length < 5) continue;
            DB_MAGASINS.push({ id: c[0].trim(), nom: c[1], atelier: c[2].toUpperCase().includes("OUI"), agrements: c[3].toUpperCase(), tPetit: c[4], tLourd: c[5] });
        }
    }

    function parseRegles(csv) {
        const lines = csv.split('\n');
        for (let i = 1; i < lines.length; i++) {
            const c = lines[i].split(',');
            if (c.length < 2) continue;
            let m = c[0].trim();
            DB_REGLES[m] = { nom: m, std: c[1], atelier: c[2], agrReq: c[3].toUpperCase().trim(), tImp: c[4], force: c[5].toUpperCase().trim(), hot: c[6] };
        }
    }

    // --- RECHERCHE MAGASIN PAR NUM√âRO ---
    function rechercherMagasin() {
        const num = document.getElementById("inputMagNum").value;
        const index = DB_MAGASINS.findIndex(m => parseInt(m.id) === parseInt(num));
        const infoDiv = document.getElementById("magFound");
        const btn = document.getElementById("btnSaveMag");

        if (index !== -1) {
            const mag = DB_MAGASINS[index];
            infoDiv.innerText = "‚úÖ Magasin trouv√© : " + mag.nom;
            btn.style.display = "block";
            btn.dataset.index = index;
        } else {
            infoDiv.innerText = num ? "‚ùå Aucun magasin avec ce num√©ro" : "";
            btn.style.display = "none";
        }
    }

    // --- FILTRAGE DES MARQUES (INTUITIF) ---
    function filtrerMarques() {
        const input = document.getElementById("marqueInput").value.toUpperCase();
        const suggBox = document.getElementById("marqueSuggestions");
        suggBox.innerHTML = "";
        
        if (input.length < 2) { 
            suggBox.style.display = "none"; 
            document.getElementById("btnCheck").style.display = "none";
            return; 
        }

        const marques = Object.keys(DB_REGLES).filter(m => m.includes(input));

        if (marques.length > 0) {
            suggBox.style.display = "block";
            marques.forEach(m => {
                let div = document.createElement("div");
                div.className = "suggestion-item";
                div.innerText = m;
                div.onclick = () => selectionnerMarque(m);
                suggBox.appendChild(div);
            });
        } else {
            suggBox.style.display = "none";
        }
    }

    function selectionnerMarque(nom) {
        document.getElementById("marqueInput").value = nom;
        document.getElementById("marqueSuggestions").style.display = "none";
        document.getElementById("btnCheck").style.display = "block";
        MARQUE_SEL = DB_REGLES[nom];
    }

    function validerSaisieMarque() {
        document.getElementById("btnCheck").style.display = "none";
        startProcess();
    }

    // --- LOGIQUE CORE ---
    function checkMemoire() {
        const m = localStorage.getItem("wecheck_mag_idx");
        if (m !== null) { MAG_INDEX = m; showApp(); } 
        else { document.getElementById("setupScreen").style.display = "block"; }
    }

    function saveMagasin() {
        MAG_INDEX = document.getElementById("btnSaveMag").dataset.index;
        localStorage.setItem("wecheck_mag_idx", MAG_INDEX);
        showApp();
    }

    function resetMagasin() { localStorage.removeItem("wecheck_mag_idx"); location.reload(); }

    function showApp() {
        document.getElementById("setupScreen").style.display = "none";
        document.getElementById("appScreen").style.display = "block";
        document.getElementById("displayStoreName").innerText = DB_MAGASINS[MAG_INDEX].nom;
    }

    function startProcess() {
        if (!MARQUE_SEL) return;
        document.getElementById("resultat").style.display = "none";
        document.getElementById("resMarqueTitle").innerText = "Process pour : " + MARQUE_SEL.nom;
        
        if (MARQUE_SEL.tImp) { afficherResultatFinal("IMPOSE"); }
        else if (MARQUE_SEL.force === "PETIT") { afficherResultatFinal("PETIT"); }
        else if (MARQUE_SEL.force === "LOURD") { afficherResultatFinal("LOURD"); }
        else { document.getElementById("choixPoids").style.display = "block"; }
    }

    function afficherResultatFinal(poids) {
        document.getElementById("choixPoids").style.display = "none";
        const mag = DB_MAGASINS[MAG_INDEX];
        let act = MARQUE_SEL.std;
        if (MARQUE_SEL.agrReq && mag.agrements.includes(MARQUE_SEL.agrReq)) { act = MARQUE_SEL.atelier; }
        else if (mag.atelier && !MARQUE_SEL.agrReq) { act = MARQUE_SEL.atelier; }
        
        let trans = (poids === "IMPOSE") ? MARQUE_SEL.tImp : (poids === "PETIT" ? mag.tPetit : mag.tLourd);
        
        document.getElementById("resAction").innerText = act;
        document.getElementById("resTransport").innerText = trans;
        document.getElementById("resHotline").innerText = MARQUE_SEL.hot || "Non renseign√©e";
        document.getElementById("resultat").style.display = "block";
    }

    function nouvelleRecherche() {
        document.getElementById("resultat").style.display = "none";
        document.getElementById("marqueInput").value = "";
        document.getElementById("btnCheck").style.display = "none";
        MARQUE_SEL = null;
    }

    init();
</script>
</body>
</html>
